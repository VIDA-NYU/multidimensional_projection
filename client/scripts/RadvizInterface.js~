var COLORSCALE = ["#1abc9c","#c0392b","#3498db","#9b59b6","#7f8c8d","#d35400","#2ecc71","#34495e","#f39c12","#bdc3c7","#f1c40f","#2c3e50","#e74c3c","#16a085","#95a5a6","#8e44ad","#27ae60","#e67e22","#2980b9"];

var COLORSCALE2 = ["#1abc9c","#c0392b","#3498db","#9b59b6","#7f8c8d","#d35400","#2ecc71","#34495e","#f39c12","#bdc3c7","#f1c40f","#2c3e50","#e74c3c","#16a085","#95a5a6","#8e44ad","#27ae60","#e67e22","#2980b9"];

var LINEARCOLORSCALE = d3.scale.linear()
    .domain([0, 0.5, 1.0])
    .range(["#e67e22", "#bdc3c7", "#2c3e50"]);
var dimensionsGroupsItems = [];
function RadvizInterface(radviz,radViews) {
    console.log("RADVIZ");
    console.log(radviz);
    console.log("RADVIEWS");
    console.log(radViews);
    this.radviz = radviz;
    this.radvizViews = radViews;
    this.selector = new Selector(this);
    this.tooltip = new Tooltip();
    this.dimensionsElement = $(".sidebar-dimensions-list");
    this.dimensions = [];
    this.dimensionsGroups = [];
    this.dimensionsGroupsAux= [];
    this.dimensionsGroupsElement = $(".sidebar-groups-list");
    this.uniqueDimensionsCount = 0;
    this.uniqueGroupsCount = 0;
    this.uniqueRemovedGroupsCount = 0;
    this.showTooltip = false;
    this.dynamicColor = false;
    this.currentSelection = [];
    this.currentSelectionMode = "reset";
    this.sizeData = this.radviz.getSizeData();

    if (!window.tsp) {
        window.tsp = new TSP(this.reorderDimensionGroup);
    }else{
        window.tsp.setCallbackSolution(this.reorderDimensionGroup);
    }
    if (!window.sortDGs){
        window.sortDGs = new SortAllDGs(this.callbackSortAllDGs)
    }else{
        window.sortDGs.setCallbackSolution(this.callbackSortAllDGs);
    }

    var _this = this;
    this.radviz.getDimensionNames().forEach(function (item,idx) {
	console.log("getDimensionNames");
        _this.addDimension(idx,idx,item);
    });
    var _this = this;
    this.radvizViews.setUpdateDimensions(function () {
	console.log("setUpdateDimensions");
        _this.radviz.updateAnchors(_this.dimensions);
        _this.drawPoints();
    });
}

RadvizInterface.prototype.destroy = function () {
    console.log("destroy");
    this.selector.destroyPolybrush();
};

RadvizInterface.prototype.getRadviz = function () {
    console.log("getRadviz");
    return this.radviz;
};

RadvizInterface.prototype.getSvg = function () {
    console.log("getSvg");
    return this.radvizViews.getSvg();
};

RadvizInterface.prototype.getSmallestCircleRadius = function () {
    console.log("getSmallestCircleRadius");
    return this.radvizViews.getSmallestCircleRadius();
};

RadvizInterface.prototype.addDimension = function (id,name,attribute) {
    console.log("addDimension");
    var dim = {id: id,name: name,attribute: attribute,available: true,group: false,pos: 0,weight: 1};
    this.dimensions[id] = dim;
    this.uniqueDimensionsCount++;
    this.draw();
};

RadvizInterface.prototype.addGroup = function (name,color) {
    console.log("addGroup");
    var id = this.uniqueGroupsCount;
    var gr = {name: name,color: color,dimensions: [],element: new RadvizDimensionGroup(id,name,color,[])};
    this.dimensionsGroups[id] = gr;
    this.uniqueGroupsCount++;
    this.radvizViews.addDimensionsGroup(gr.element);
    this.draw();
    this.drawPoints();
};

RadvizInterface.prototype.removeGroup = function (groupId) {
    console.log("removeGroup");
    groupId = parseInt(groupId);
    this.dimensionsGroups[groupId] = null;
    this.uniqueRemovedGroupsCount++;
    this.radvizViews.removeDimensionsGroup(groupId);
    var _this = this;
    this.dimensions.forEach(function (d,i) {
        if (d.group == groupId) {
            _this.dimensions[i].available = true;
            _this.dimensions[i].group = false;
        }
    });
    if (this.uniqueRemovedGroupsCount == this.uniqueGroupsCount) {
        this.uniqueGroupsCount = 0;
        this.uniqueRemovedGroupsCount = 0;
        this.dimensionsGroups = [];
    }
    this.radviz.setAnchors(this.dimensions);
    this.drawPoints();
    this.draw();
};

RadvizInterface.prototype.reorderDimensionGroup = function (res) {
    console.log("reordererDimensionGroup");
    orderObj = JSON.parse(res);
    console.log(orderObj);
    var _this = window.radInterface;
    var spacing = (orderObj.cities.length > 0) ? 360/orderObj.cities.length : 0;
    var offset = orderObj.offset * 180 / Math.PI;
    _this.dimensions.forEach(function (item,idx) {
        if (item.group === orderObj.groupId) {
            if (orderObj.cities.indexOf(item.id) >= 0) {
                item.pos = offset + spacing * orderObj.cities.indexOf(item.id);
                _this.radvizViews.updateDimensionPosition(item.id,item.group,item.pos);
            }
        }
    });
    _this.radviz.setAnchors(_this.dimensions);
    _this.drawPoints();
    _this.draw();
};

RadvizInterface.prototype.callbackSortAllDGs = function(x){
    console.log("callbackSortAllDGs");
    console.log(x);

    var _this = window.radInterface;

    var groupIds = Object.keys(x.anchorAngles);


    for (var i = 0; i < groupIds.length; i++){
        var groupId = groupIds[i];
        var offset = x.offsets[groupId];
        for (var j = 0; j < x.anchorIndex[groupId].length; j++){
            var dimId = x.anchorIndex[groupId][j];
            var dimAngle = x.anchorAngles[groupId][j];
            var pos = (offset + dimAngle)*180 / Math.PI;
            _this.radvizViews.updateDimensionPosition(dimId,groupId,pos);

            _this.dimensions[parseInt(dimId)].pos = pos;


        }
        _this.radviz.setAnchors(_this.dimensions);
        _this.drawPoints();
        _this.draw();
    }

    /*var spacing = (orderObj.cities.length > 0) ? 360/orderObj.cities.length : 0;
    var offset = orderObj.offset * 180 / Math.PI;
    _this.dimensions.forEach(function (item,idx) {
        if (item.group === orderObj.groupId) {
            if (orderObj.cities.indexOf(item.id) >= 0) {
                item.pos = offset + spacing * orderObj.cities.indexOf(item.id);
                _this.radvizViews.updateDimensionPosition(item.id,item.group,item.pos);
            }
        }
    });
    _this.radviz.setAnchors(_this.dimensions);
    _this.drawPoints();
    _this.draw();

    */
};

// RadvizInterface.prototype.sortAllDGs = function (){
//     //console.log("sortAllDGs");
//     /*Fala quais angulos foram usados*/
//     var dgs = {};
//     var idsDAs = {};
//     for (var i in this.dimensions){
//         if (!this.dimensions[i].available){
//             if (!dgs[this.dimensions[i].group]){
//                 dgs[this.dimensions[i].group] = [];
//                 idsDAs[this.dimensions[i].group] = [];
//             }
//             dgs[this.dimensions[i].group].push((this.dimensions[i].pos * Math.PI * 2) / 360);
//             idsDAs[this.dimensions[i].group].push(i);
//         }
//     }

//     window.sortDGs.solveSortAllDGs(dgs,idsDAs, this.sigmoid.scale, this.sigmoid.translate);
//     /**/
// };

RadvizInterface.prototype.addDimensionToGroup = function (dimensionId,groupId) {
    console.log("addDimensionToGroup");
    dimensionId = parseInt(dimensionId);
    groupId = parseInt(groupId);
    this.dimensions[dimensionId].available = false;
    this.dimensions[dimensionId].group = groupId;
    this.dimensionsGroups[groupId].dimensions.push(dimensionId);
    this.radvizViews.addDimensionToGroup(this.dimensions[dimensionId],groupId);

    /*anglesUsed: angles which were used */
    var anglesUsed = [];
    for (var i in this.dimensions){
        if ((!this.dimensions[i].available) && (this.dimensions[i].group != groupId)) {
            anglesUsed.push((this.dimensions[i].pos * Math.PI * 2) / 360); //send the data in radians to R
        }
    }
    /**/
    return anglesUsed;
};

RadvizInterface.prototype.removeDimensionFromGroup = function (dimensionId) {
    console.log("removeDimensionFromGroup");
    dimensionId = parseInt(dimensionId);
    if (!this.dimensions[dimensionId].available) {
        var oldGroup = this.dimensions[dimensionId].group;
        this.dimensions[dimensionId].available = true;
        this.dimensions[dimensionId].group = false;
        var index = this.dimensionsGroups[oldGroup].dimensions.indexOf(parseInt(dimensionId));
        if (index > -1) {
            this.dimensionsGroups[oldGroup].dimensions.splice(index,1);
            this.radvizViews.removeDimensionFromGroup(dimensionId,oldGroup);
            this.radviz.setAnchors(this.dimensions);
        }
        this.drawPoints();
        this.draw();
    }
};

RadvizInterface.prototype.getDimensionPosition = function (dimensionId) {
    console.log("getDimensionPosition");
    var dim = this.dimensions[dimensionId];
    if (dim.available === true) {
        return false;
    } else {
        var groupId = dim.group;
        var pos = dim.pos;
        return {group: groupId,position: pos,weight: dim.weight};
    }
};

RadvizInterface.prototype.draw = function () {
    console.log("draw");
    this.dimensionsElement.children().remove();
    this.dimensionsGroupsElement.children().remove();
    var _this = this;
    this.dimensionsGroups.forEach(function (d,i) {
	console.log(d);
	console.log(i);
        if (d) {
            $(".sidebar-groups-list").append("<div data-group-id='" + i + "' class='sidebar-groups-list-item sidebar-groups-list-item-" + i + "' style='background-color: " + d.color + "'>" +
                                             "<div data-group-id='" + i + "' class='sidebar-groups-list-item-element sidebar-groups-list-item-remove'>x</div>" +
                                             "<div data-group-id='" + i + "' class='sidebar-groups-list-item-element sidebar-groups-list-item-element-group-" + i + " sidebar-groups-list-item-title'>" + d.name + "</div></div>");
            d.dimensions.forEach(function (e) {
                $(".sidebar-groups-list-item-" + i).append("<div data-dimension-id='" + e + "' class='sidebar-groups-list-item-dimension-" + e + " sidebar-groups-list-item-element droppable-element'>" + _this.dimensions[e].attribute + "</div>");
            });
        }
    });
    $(".sidebar-groups-list-item-element").off("click");
    $(".sidebar-groups-list-item-element").on("click", function () {
        _this.activeDimensionSlider($(this).attr("data-dimension-id"));
    });
    $(".sidebar-groups-list-item-title").off("click");
    $(".sidebar-groups-list-item-title").on("click", function () {
        _this.activeGroupSlider($(this).attr("data-group-id"));
    });
    this.dimensions.forEach(function (d,i) {

        if (d.available) {
            var dimensionsGroupsuu=[];
            dimensionsGroupsuu.push(d.attribute);
            $(".sidebar-dimensions-list").append("<div data-dimension-id='" + i + "' class='sidebar-dimensions-list-item droppable-element'>" + d.attribute + "</div>");
            dimensionsGroupsItems.push(d.attribute);

        }
    });

    $( ".droppable-element" ).draggable({ revert: "invalid" });
    $( ".sidebar-groups-list-item" ).droppable({
        accept: ".droppable-element",
        activeClass: "ui-state-hover",
        hoverClass: "ui-state-active",
        drop: function( event, ui ) {
            var dimension = ui.draggable.attr("data-dimension-id");
            var group = $(this).attr("data-group-id");
            _this.removeDimensionFromGroup(dimension);
            _this.addDimensionToGroup(dimension,group);
            _this.hideDimensionSlider();
            _this.draw();
        }
    });
    $( ".sidebar-dimensions-list" ).droppable({
        accept: ".droppable-element",
        activeClass: "ui-state-hover",
        hoverClass: "ui-state-active",
        drop: function( event, ui ) {
            var dimension = ui.draggable.attr("data-dimension-id");
            _this.removeDimensionFromGroup(dimension);
            _this.hideDimensionSlider();
            _this.draw();
        }
    });

    $("#btn-add-group").off("click");
    $("#btn-add-group").on("click",function (e) {
        e.preventDefault();
        _this.addGroup("Group " + (_this.uniqueGroupsCount + 1),COLORSCALE[_this.uniqueGroupsCount]);
        for(i=0; i<_this.sizeData-2; i++){ //-2 because we do not have to project last two columns (labels and urls) as anchors in the RadViz.
          var a =1;
          var b =0;
          _this.removeDimensionFromGroup(i);
          _this.addDimensionToGroup(i,b);
          _this.hideDimensionSlider();
          _this.draw();
        }
    });
    $(".sidebar-groups-list-item-remove").off("click");
    $(".sidebar-groups-list-item-remove").on("click",function () {
        _this.removeGroup($(this).attr("data-group-id"));
    });

};

RadvizInterface.prototype.callAddGroupButton = function(){
    var _this = this;
    _this.addGroup("Group " + (_this.uniqueGroupsCount + 1),COLORSCALE[_this.uniqueGroupsCount]);
    var groupId = 0;
    var anglesUsed = undefined;
    console.log("DIMENSIONS ");
    console.log(this.dimensions);
    for(i=0; i<_this.sizeData-2; i++){ //-2 because we do not have to project last two columns (labels and urls) as anchors in the RadViz.
        var a =1;
        var b =0;
        _this.removeDimensionFromGroup(i);
        anglesUsed = _this.addDimensionToGroup(i,b);
    }
    console.log("ANGLES USED " + anglesUsed);
    window.tsp.solveTSPCities(this.dimensionsGroups[groupId].dimensions,groupId, anglesUsed);
    //this.radviz.setAnchors(this.dimensions);
    // this.draw();
    // this.drawPoints();

};

RadvizInterface.prototype.drawPoints = function () {
    console.log("drawPoints");
    var smallestCircle = this.getSmallestCircleRadius();

    var xValue = function (d) {
        return d.x;
    };
    var xScale = d3.scale.linear().range([-smallestCircle, smallestCircle]).domain([-1, 1]);//input domain, output range
    var xMap = function (d) {
	console.log(d);
        return xScale(xValue(d));
    };
    var yValue = function (d) {
        return d.y;
    };
    var yScale = d3.scale.linear().range([-smallestCircle, smallestCircle]).domain([-1, 1]);//input domain, output range
    var yMap = function (d) {
        return yScale(yValue(d));
    };

    var _this = this;
    var proj = this.radviz.computeProjection();
    console.log(proj);
    _this.getSvg().selectAll(".dot").remove();
    if (proj.length > 0){
        _this.getSvg().selectAll(".dot")
            .data(proj)
            .enter().append("circle")
            .attr("class", function (d,idx) {
                if (d.hidden) {
                    return "dot dot-id-" + idx + " hide";
                } else {
                    return "dot dot-id-" + idx;
                }
            })
            .attr("data-is-hidden", function (d,idx) {
                if (d.hidden) {
                    return "1";
                } else {
                    return "0";
                }
            })
            .style("fill", function (d) {
                if (_this.dynamicColor) {
                    if (_this.radviz.isContinuous) {
                        return LINEARCOLORSCALE(d.color);
                    } else {
                        return COLORSCALE2[parseInt(d.color)];
                    }
                } else {
                    return LINEARCOLORSCALE(0.0);
                }
            })
            .attr("id", function (d,idx) {
                return idx;
            })
            .attr("r", 3.5)
            .attr("cx", xMap)
            .attr("cy", yMap)
            .style("stroke","black")
            .style("opacity","0.65")
            .style("stroke-width", function (d) {
                if (d.selected) {
                    return 1.5;
                } else {
                    return 0;
                }
            })
            .on("mouseover", function (d) {
                if (d.tip !== null && _this.showTooltip) {
                    _this.tooltip.show(d.tip);
                }
            })
            .on("mouseout", function (d) {
                if (d.tip !== null) {
                    _this.tooltip.hide();
                }
            });
    }
};

RadvizInterface.prototype.activeDimensionSlider = function (dimensionId) {
    console.log("activeDimensionSlider");
    $("#dimensionSlider").removeClass("hidden");
    $(".sidebar-groups-list-item-element").removeClass("selected");
    $(".sidebar-groups-list-item-dimension-" + dimensionId).addClass("selected");
    $("#dimensionSlider label").html(this.dimensions[dimensionId].attribute + " weight: ");
    var slider = $("#dimensionSliderController").data("ionRangeSlider");
    var _this = this;
    slider.update({from: parseFloat(this.dimensions[dimensionId].weight),onChange: function (data) {
        var newWeight = parseFloat(data.from);
        _this.dimensions[dimensionId].weight = newWeight;
        _this.radvizViews.updateDimensions();
    }});
};


RadvizInterface.prototype.activeGroupSlider = function (groupId) {
    console.log("activeGroupSlider");
    $("#dimensionSlider").removeClass("hidden");
    $(".sidebar-groups-list-item-element").removeClass("selected");
    $(".sidebar-groups-list-item-element-group-" + groupId).addClass("selected");
    $("#dimensionSlider label").html(this.dimensionsGroups[groupId].name + " weight: ");
    var slider = $("#dimensionSliderController").data("ionRangeSlider");
    var _this = this;
    slider.update({from: parseFloat(1.0),onChange: function (data) {
        var newWeight = (isNaN(parseFloat(data.from))) ? 1.0 : parseFloat(data.from);
        _this.dimensionsGroups[groupId].dimensions.forEach(function (dim,idx) {
            _this.dimensions[dim].weight = newWeight;
        });
        _this.radvizViews.updateDimensions();
    }});
};

RadvizInterface.prototype.hideDimensionSlider = function () {
    $("#dimensionSlider").addClass("hidden");
};

RadvizInterface.prototype.resetSelection = function () {
    console.log("resetSelection");
    this.currentSelection = [];
    this.selectMultipleItems([]);
};

RadvizInterface.prototype.selectElementsFromDistanceToAnchor = function (distance,anchor) {
    console.log("selectElementsFromDistanceToAnchor");
    this.currentSelection = [];
    var _this = this;
    var rad = _this.radvizViews.options.maxCircleRadius;
    var anchorX = rad * Math.cos(Math.radians(anchor.pos));
    var anchorY = rad * Math.sin(Math.radians(anchor.pos));

    var selectedElements = [];
    _this.radvizViews.svg.selectAll(".dot")
        .classed("selected", function(d) {
            var id = d3.select(this).attr("id");
            if (parseInt(d3.select(this).attr("data-is-hidden")) == 0) {
                var distX = parseFloat(d3.select(this).attr("cx")) - anchorX;
                var distY = parseFloat(d3.select(this).attr("cy")) - anchorY;
                var dist = Math.sqrt(distX*distX + distY*distY);
                var scale = (dist/(parseFloat(rad)*2));
                if (scale < distance) {
                    selectedElements.push(parseInt(d3.select(this).attr("id")));
                    return true;
                } else {
                    return false;
                }
            }
        });

    this.selectMultipleItems(selectedElements);
};

RadvizInterface.prototype.selectMultipleItems = function (selection) {
    console.log("selectMultipleItems");
    var _this = this;
    if (this.currentSelectionMode === "add") {
        this.currentSelection = this.currentSelection.concat(selection);
    }
    if (this.currentSelectionMode === "reset" || this.currentSelectionMode === "anchor") {
        this.currentSelection = selection;
    }
    if (this.currentSelectionMode === "sub") {
        selection.forEach(function (id) {
            var idxCurr = _this.currentSelection.indexOf(id);
            if (idxCurr != -1) {
                _this.currentSelection.splice(idxCurr,1);
            }
        });
    }
    this.radviz.setSelected(this.currentSelection);
    // this.radviz.setSelectedWordCloud(this.currentSelection);
    this.drawPoints();
};

RadvizInterface.prototype.doSelectionAction = function (actionMode) {
    console.log("doSelectionAction");
    if (actionMode == 'show-all') {
        window.radInterface.radviz.unhideAll();
    } else if (actionMode == 'hide-selected') {
        window.radInterface.radviz.setHideElements(window.radInterface.currentSelection);
    } else if (actionMode == 'hide-unselected') {
        window.radInterface.radviz.setHideUnselected(window.radInterface.currentSelection);
    }
    window.radInterface.currentSelection=[];
    window.radInterface.radviz.setSelected(this.currentSelection);

    window.radInterface.drawPoints();
};

// RadvizInterface.prototype.updateSigmoid = function (translate,scale) {
//     //console.log("updateSigmoid");
//     var _this = this;
//     window.radInterface.radviz.updateSigmoid(translate,scale);
//     window.radInterface.drawPoints();
// };
